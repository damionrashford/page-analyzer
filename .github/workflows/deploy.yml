name: Build and Deploy to Gist

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Create or Update Gist
        id: gist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const distDir = path.join(process.cwd(), 'dist');
            const hostJs = fs.readFileSync(path.join(distDir, 'host.min.js'), 'utf-8');
            const remoteJs = fs.readFileSync(path.join(distDir, 'remote.min.js'), 'utf-8');
            const remoteHtml = fs.readFileSync(path.join(distDir, 'remote.html'), 'utf-8');
            
            const gistId = process.env.GIST_ID || '';
            
            const files = {
              'host.min.js': { content: hostJs },
              'remote.min.js': { content: remoteJs },
              'remote.html': { content: remoteHtml }
            };
            
            let gist;
            
            if (gistId && gistId !== '') {
              try {
                const existingGist = await github.rest.gists.get({ gist_id: gistId });
                gist = await github.rest.gists.update({
                  gist_id: gistId,
                  files: files
                });
                console.log('✓ Updated existing Gist');
              } catch (error) {
                console.log('Gist not found, creating new one...');
                gist = await github.rest.gists.create({
                  description: 'Page Analyzer - Built files',
                  public: true,
                  files: files
                });
                console.log('✓ Created new Gist');
              }
            } else {
              gist = await github.rest.gists.create({
                description: 'Page Analyzer - Built files',
                public: true,
                files: files
              });
              console.log('✓ Created new Gist');
            }
            
            const gistUrl = gist.data.html_url;
            const gistIdOutput = gist.data.id;
            const hostUrl = `https://gist.githubusercontent.com/damionrashford/${gistIdOutput}/raw/host.min.js`;
            const remoteHtmlUrl = `https://gist.githubusercontent.com/damionrashford/${gistIdOutput}/raw/remote.html`;
            
            console.log(`Gist URL: ${gistUrl}`);
            console.log(`Gist ID: ${gistIdOutput}`);
            console.log(`Host JS URL: ${hostUrl}`);
            console.log(`Remote HTML URL: ${remoteHtmlUrl}`);
            
            core.setOutput('gist_id', gistIdOutput);
            core.setOutput('gist_url', gistUrl);
            core.setOutput('host_url', hostUrl);
            core.setOutput('remote_html_url', remoteHtmlUrl)
        env:
          GIST_ID: ${{ secrets.GIST_ID }}

      - name: Update files with Gist URLs
        run: |
          cd dist
          HOST_URL="${{ steps.gist.outputs.host_url }}"
          REMOTE_HTML_URL="${{ steps.gist.outputs.remote_html_url }}"
          
          BOOKMARKLET='javascript:(function(){var s=document.createElement("script");s.src="'$HOST_URL'";s.onload=function(){if(window.PageAnalyzer){window.PageAnalyzer.init();}};if(!document.getElementById("page-analyzer-script")){s.id="page-analyzer-script";document.head.appendChild(s);}else{console.warn("Page Analyzer already loaded");}})();'
          
          echo "$BOOKMARKLET" > bookmarklet.js
          
          echo "✓ Updated bookmarklet.js with Gist URLs"
          echo "Gist ID: ${{ steps.gist.outputs.gist_id }}"
          echo "Bookmarklet ready to use!"

      - name: Create Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-files
          path: dist/
          retention-days: 30

      - name: Update host.js, README, and install.html with Gist URLs
        run: |
          REMOTE_HTML_URL="${{ steps.gist.outputs.remote_html_url }}"
          HOST_URL="${{ steps.gist.outputs.host_url }}"
          GIST_ID="${{ steps.gist.outputs.gist_id }}"
          
          sed -i.bak "s|https://gist.githubusercontent.com/damionrashford/GIST_ID/raw/remote.html|$REMOTE_HTML_URL|g" src/host/host.js
          rm src/host/host.js.bak
          
          BOOKMARKLET_CODE="javascript:(function(){var s=document.createElement('script');s.src='$HOST_URL';s.onload=function(){if(window.PageAnalyzer){window.PageAnalyzer.init();}};if(!document.getElementById('page-analyzer-script')){s.id='page-analyzer-script';document.head.appendChild(s);}else{console.warn('Page Analyzer already loaded');}})();"
          
          sed -i.bak "s|https://gist.githubusercontent.com/damionrashford/GIST_ID/raw/host.min.js|$HOST_URL|g" README.md
          rm README.md.bak
          
          sed -i.bak "s|https://gist.githubusercontent.com/damionrashford/GIST_ID/raw/host.min.js|$HOST_URL|g" install.html
          rm install.html.bak
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/host/host.js README.md install.html
          git commit -m "Update host.js, README, and install.html with Gist URLs from deployment" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
